<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Lab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
    <meta name="theme-color" content="#3B82F6">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎓</text></svg>">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACfklEQVR4AWL4/f9/A/D5/z8DUAhmgCgYkARiUCDRjABRMEgCEYVAowYA0VAoYgAoiARzQBgIDQAGBv4XyvsC/P3/f4Z/f5/B3/8/w98/wN8/IMOADAMwDEDIDYD4//8/A1f9/7///f/9++/v919//z7//v/7A8i/f4B8/Pz/Cfj58wn49esZ8O3rGbD54wnw/fsZ8P77CfD/zwAGgYjBixd/37x9+fr1B5D/+wsA5u/ffz9/f/8Bf//+cv75/AsoA2A+fPj1/fv37x8w/v//H8A2ADyZQB6A5P//H/D/+An49Qvw9QsA8+fPnwA2gBb8/Plz/fv3758/AIYDBsD4/v37z58/f3//AMLf318A9fXv37+/fwA2B/D5+gWkXwE2AD5++gQgHR0AbAA8f/4EJB4dAGwAPDw6ANgAeP/+CUiADgA2AB4+fQKSIAwAbAA8BJiAE4gBAbCfn58fAMQAh3/AQAD6/9+/f7+BMAA2AB4+fQKSQBgA2AA4+uQJSAAYANgAOHzyBCQADgA2AB4+fQKSYBgA2AB4+fQLSCQwAGwAzM/P/wAJA8jBnz9/fvz48f///wPw9/cHAMQAh/8BAwHo/3+/f3/BAADYAHz69AnIBgMAGwCHDh1AbAAsX74EyMDAwABgA2A+Pz//gAsD6P//b2BgAGAD4O/v/z9//vz7+QXAADB//vz7BQUFABgAmJ+f/8EDA+j/f2BggA3Ag4ODf3BwcPv5+fXv37+/fwCwAQ4cOADYAJg/f/4DDgbQ//+3t7eBDAA2AA4cOADYAJg/f/4DDAzQ//9bW1oE2AB8/vwJyAYDABsAhw4dAGwALL9+AcnAwMAAYANg/v37DzA4QP//X1lZBbAB+P37F5BtBgA2AA4ePQKyYQDYADh49AjIBgMAGwCHDh0AbACsX7+C5O3t7QBgwIABYwCkGRgYGAAfHx8AAwYwQKTRgB0dHQADBnBALGwAHDhwAGBAFgwAEQwGgAACDCDAwABiAAD//wMAghzQnJ2nAAAAAElFTkSuQmCC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EduTech Lab">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #667eea; color: #1a1a1a; }
        .main-container { height: 100vh; display: flex; flex-direction: column; }
        .animated-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .pwa-install { position: fixed; top: 1rem; right: 1rem; background: #4CAF50; color: white; border: none; padding: 0.75rem; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); z-index: 1000; display: none; transition: all 0.3s ease; }
        .pwa-install:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4); }
        .header { text-align: center; padding: 2rem; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); margin: 1rem; border-radius: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .header h1 { font-size: 3rem; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .header h2 { font-size: 1.5rem; color: #374151; margin-bottom: 0.5rem; }
        .header p { color: #6B7280; font-size: 1.1rem; }
        .stats-bar { display: flex; justify-content: center; gap: 1rem; margin: 1rem; flex-wrap: wrap; }
        .stat-item { background: rgba(255, 255, 255, 0.9); padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .stat-stars { background: #FEF3C7; color: #92400E; } .stat-score { background: #D1FAE5; color: #065F46; } .stat-level { background: #E0E7FF; color: #3730A3; }
        .classes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; padding: 1rem; max-width: 1200px; margin: 0 auto; overflow-y: auto; }
        .class-card { background: rgba(255, 255, 255, 0.95); border-radius: 1.5rem; padding: 2rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .class-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .card-emoji { font-size: 4rem; margin-bottom: 1rem; display: block; } .card-title { font-size: 1.3rem; font-weight: bold; color: #1F2937; margin-bottom: 0.5rem; } .card-description { color: #6B7280; font-size: 0.9rem; margin-bottom: 1rem; } .card-badges { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; } .badge { padding: 0.3rem 0.8rem; border-radius: 50px; font-size: 0.8rem; font-weight: 500; } .badge.math { background: #EFF6FF; color: #1E40AF; } .badge.coding { background: #ECFDF5; color: #059669; } .badge.thinking { background: #FAF5FF; color: #7C3AED; }
        .games-section { display: none; padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .game-card { background: rgba(255, 255, 255, 0.95); border-radius: 1.5rem; padding: 2rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); text-align: center; }
        .game-card:hover { transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .nav-btn { background: rgba(255, 255, 255, 0.9); border: none; padding: 0.75rem 1.5rem; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .nav-btn:hover { background: rgba(255, 255, 255, 1); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }
        .reset-btn { background: #FEE2E2; color: #DC2626; } .reset-btn:hover { background: #FEF2F2; }
        
        /** MODIFICA: Layout di gioco flessibile in altezza **/
        .game-interface { display: none; flex-direction: column; height: 100vh; background: rgba(255, 255, 255, 0.98); margin: 1rem; border-radius: 2rem; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        .game-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 1rem; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        
        /** MODIFICA: Layout specifico per bambini piccoli (pulsanti in basso) **/
        .layout-young-child .game-interface { flex-direction: column-reverse; }
        .layout-young-child .game-navigation { order: -1; /* Mette la navigazione in alto */ }
        
        .difficulty-indicator { display: flex; align-items: center; gap: 0.25rem; } .difficulty-star { font-size: 1.2rem; color: #ddd; } .difficulty-star.active { color: #FFD700; }
        
        /** MODIFICA: Contenuto del gioco che occupa lo spazio disponibile **/
        .game-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; padding-bottom: 1rem; }
        .game-content { background: #f8f9fa; border-radius: 1rem; padding: 1.5rem; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; }
        .game-navigation { text-align: center; margin-top: 1rem; flex-shrink: 0; }
        
        .question { font-size: clamp(1.2rem, 4vw, 2rem); font-weight: bold; text-align: center; margin-bottom: 1.5rem; color: #333; }
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; width: 100%; max-width: 800px; }
        .answer-btn { padding: 1.5rem; font-size: clamp(1rem, 4vw, 1.5rem); border: 2px solid #ddd; border-radius: 1rem; background: white; cursor: pointer; transition: all 0.3s ease; }
        .answer-btn:hover { border-color: #667eea; background: #f0f4ff; transform: scale(1.05); }
        .answer-btn.correct { background: #4CAF50; color: white; border-color: #45a049; }
        .answer-btn.wrong { background: #f44336; color: white; border-color: #d32f2f; }
        
        .counting-objects { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem; }
        .counting-object { font-size: 2.5rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; animation: bounceIn 0.5s ease-out; }

        /** MODIFICA: CSS Frazioni migliorato **/
        .fraction-visual { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1rem; }
        .pizza-container { position: relative; width: 200px; height: 200px; border-radius: 50%; background: #FDEBD0; border: 3px solid #AF601A; }
        .pizza-slice { position: absolute; width: 100px; height: 200px; top: 0; left: 100px; transform-origin: 0 100px; transition: background-color 0.3s; cursor: pointer; }
        .pizza-slice:before { content: ''; position: absolute; width: 100px; height: 200px; background: transparent; border-radius: 0 100px 100px 0; border: 1px dashed #AF601A; }
        .pizza-slice.filled { background-color: rgba(255, 107, 53, 0.7); }

        .footer { background: rgba(31, 41, 55, 0.95); color: white; text-align: center; padding: 2rem; margin: 2rem 1rem 1rem; border-radius: 1rem; }
        .message { padding: 1rem; border-radius: 1rem; margin: 1rem auto; text-align: center; font-weight: bold; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; width: 90%; max-width: 600px;}
        .message.show { opacity: 1; transform: translateY(0); }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .classes-grid { grid-template-columns: 1fr; }
            .question { font-size: 1.5rem; }
            .game-interface { margin: 0.5rem; padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <button class="pwa-install" id="installBtn" title="Installa l'app">📱</button>

    <div class="main-container">
        <div id="homepage" style="display: flex; flex-direction: column; height: 100%;">
            <header class="header">
                <h1>🎓 EduTech Lab</h1>
                <h2>Pensiero Computazionale per la Scuola Primaria</h2>
                <p>Scegli la tua classe e inizia il viaggio nel mondo del coding!</p>
            </header>
            <div id="stats-bar" class="stats-bar" style="display: none;">
                 <div class="stat-item stat-stars">⭐ <span id="stars-count">0</span> stelle</div>
                 <div class="stat-item stat-score">🏆 <span id="score-count">0</span> punti</div>
                 <div class="stat-item stat-level">🧠 Livello <span id="level-count">1</span></div>
                 <button class="nav-btn reset-btn" onclick="resetProgress()">🔄 Reset</button>
            </div>
            <div class="classes-grid">
                <div class="class-card" onclick="selectClass(1)">
                    <div class="card-emoji">🌱</div><h3 class="card-title">Classe 1ª</h3><p class="card-description">I primi passi nel mondo digitale (6-7 anni)</p>
                </div>
                <div class="class-card" onclick="selectClass(2)">
                    <div class="card-emoji">🌿</div><h3 class="card-title">Classe 2ª</h3><p class="card-description">Esploratori digitali curiosi (7-8 anni)</p>
                </div>
                <div class="class-card" onclick="selectClass(3)">
                    <div class="card-emoji">🌳</div><h3 class="card-title">Classe 3ª</h3><p class="card-description">Logica e primi algoritmi (8-9 anni)</p>
                </div>
                <div class="class-card" onclick="selectClass(4)">
                    <div class="card-emoji">🌲</div><h3 class="card-title">Classe 4ª</h3><p class="card-description">Algoritmi e frazioni (9-10 anni)</p>
                </div>
                <div class="class-card" onclick="selectClass(5)">
                    <div class="card-emoji">🌺</div><h3 class="card-title">Classe 5ª</h3><p class="card-description">Programmatori junior (10-11 anni)</p>
                </div>
            </div>
            <footer class="footer">
                <p style="font-size: 0.9rem; color: #9CA3AF;">© 2025 EduTech Lab by <strong style="color: #60A5FA;">Fabio Rizzotto</strong></p>
                <button class="nav-btn" onclick="window.location.href='https://sites.google.com/view/fabiorizzotto/risorse-didattiche/gamification'" style="margin-top: 1rem;">Torna al sito</button>
            </footer>
        </div>

        <div id="gamesSection" class="games-section">
            </div>

        <div id="gameInterface" class="game-interface">
            <div class="game-header">
                <div>
                    <h2 id="gameTitle">Gioco</h2>
                    <div class="difficulty-indicator">
                        <span>Difficoltà:</span>
                        <span class="difficulty-star" data-level="1">⭐</span><span class="difficulty-star" data-level="2">⭐</span><span class="difficulty-star" data-level="3">⭐</span><span class="difficulty-star" data-level="4">⭐</span><span class="difficulty-star" data-level="5">⭐</span>
                    </div>
                </div>
                <div class="game-controls">
                    <button class="nav-btn" onclick="backToGames()">🎮 Torna ai Giochi</button>
                </div>
            </div>
            <div class="message" id="messageContainer"></div>
             <div class="game-content-wrapper">
                 <div class="game-content" id="gameContent"></div>
            </div>
            <div class="game-navigation">
                <button class="btn btn-primary" onclick="nextQuestion()">🔄 Prossima Domanda</button>
                <button class="btn btn-primary" onclick="checkAnswer()" style="display: none;" id="checkAnswerBtn">✅ Verifica</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentClass = 1;
        let currentGame = '';
        let adaptiveData = {};
        let gameState = {};
        let score = 0, stars = 0, level = 1;

        const classesData = {
            1: { games: [{ id: 'conteggio' }, { id: 'addizioni-visual' }, { id: 'sequenze-base' }, { id: 'pattern-semplici' }] },
            2: { games: [{ id: 'conteggio' }, { id: 'operazioni-entro-20' }, { id: 'debugging-visuale' }] },
            3: { games: [{ id: 'tabelline-base' }, { id: 'loop-semplici' }, { id: 'if-then-base' }] },
            4: { games: [{ id: 'frazioni-visual' }, { id: 'variabili-semplici' }, { id: 'algoritmi-avanzati' }] },
            5: { games: [{ id: 'frazioni-visual' }, { id: 'statistica-base' }, { id: 'progetti-completi' }] }
        };

        // PWA Installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        function resetAdaptiveData() {
            adaptiveData = {
                consecutiveCorrect: 0, consecutiveWrong: 0, totalQuestions: 0,
                correctAnswers: 0, currentDifficulty: 1, maxDifficulty: 5
            };
        }

        function saveProgress() {
            localStorage.setItem('edutech_score', score);
            localStorage.setItem('edutech_stars', stars);
            localStorage.setItem('edutech_level', level);
            localStorage.setItem('edutech_adaptive', JSON.stringify(adaptiveData));
            updateStatsDisplay();
        }

        function loadProgress() {
            score = parseInt(localStorage.getItem('edutech_score') || '0');
            stars = parseInt(localStorage.getItem('edutech_stars') || '0');
            level = parseInt(localStorage.getItem('edutech_level') || '1');
            const savedAdaptive = localStorage.getItem('edutech_adaptive');
            if (savedAdaptive) {
                adaptiveData = JSON.parse(savedAdaptive);
            } else {
                resetAdaptiveData();
            }
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('stars-count').textContent = stars;
            document.getElementById('score-count').textContent = score;
            document.getElementById('level-count').textContent = level;
            document.querySelectorAll('.difficulty-star').forEach((star, index) => {
                star.classList.toggle('active', index < adaptiveData.currentDifficulty);
            });
            document.getElementById('stats-bar').style.display = (score > 0 || stars > 0) ? 'flex' : 'none';
        }

        function resetProgress() {
            if (confirm('Sei sicuro di voler resettare tutti i progressi?')) {
                score = 0; stars = 0; level = 1;
                resetAdaptiveData();
                localStorage.clear();
                updateStatsDisplay();
            }
        }
        
        function navigateTo(sectionId) {
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById(sectionId).style.display = sectionId === 'gameInterface' ? 'flex' : 'block';
        }

        function selectClass(classNum) {
            currentClass = classNum;
            // /** MODIFICA: Applica layout speciale per la classe 1 **/
            document.body.classList.toggle('layout-young-child', classNum === 1);
            
            const games = classesData[classNum].games;
            const gamesGrid = document.createElement('div');
            gamesGrid.className = 'games-grid';
            games.forEach(game => {
                 const gameCard = document.createElement('div');
                 gameCard.className = 'game-card';
                 gameCard.onclick = () => startGame(game.id);
                 gameCard.innerHTML = `<h3>${getGameDetails(game.id).name}</h3><p>${getGameDetails(game.id).desc}</p>`;
                 gamesGrid.appendChild(gameCard);
            });

            const gamesSection = document.getElementById('gamesSection');
            gamesSection.innerHTML = `
                <div class="game-header">
                    <h2>Giochi per la Classe ${classNum}ª</h2>
                    <button class="nav-btn" onclick="backToHome()">🏠 Torna alla Home</button>
                </div>`;
            gamesSection.appendChild(gamesGrid);
            navigateTo('gamesSection');
        }

        function getGameDetails(gameId) {
            const details = {
                'conteggio': {name: '🔢 Conteggio Magico', desc: 'Conta oggetti e associa al numero'},
                'addizioni-visual': {name: '➕ Addizioni Visuali', desc: 'Somme con oggetti colorati'},
                'sequenze-base': {name: '📝 Prime Sequenze', desc: 'Ordina azioni quotidiane'},
                'pattern-semplici': {name: '🌈 Trova il Pattern', desc: 'Riconosci sequenze colorate'},
                'operazioni-entro-20': {name: '🧮 Operazioni Rapide', desc: 'Addizioni e sottrazioni veloci'},
                'debugging-visuale': {name: '🐛 Detective del Codice', desc: 'Trova l\'errore nella sequenza'},
                'tabelline-base': {name: '✖️ Tabelline Interattive', desc: 'Moltiplicazioni divertenti'},
                'loop-semplici': {name: '🔄 I Miei Primi Loop', desc: 'Ripetizioni e cicli semplici'},
                'if-then-base': {name: '🤔 Se... Allora...', desc: 'Prime condizioni logiche'},
                'frazioni-visual': {name: '🍕 Pizza delle Frazioni', desc: 'Visualizza e opera con le frazioni'},
                'variabili-semplici': {name: '📦 Le Mie Prime Variabili', desc: 'Contenitori per i dati'},
                'algoritmi-avanzati': {name: '🧠 Algoritmi Intelligenti', desc: 'Risoluzione di problemi'},
                'statistica-base': {name: '📊 I Miei Primi Grafici', desc: 'Raccogli e analizza dati'},
                'progetti-completi': {name: '🎮 Crea il Tuo Gioco', desc: 'Progetti completi con interfaccia'}
            };
            return details[gameId] || {name: 'Gioco', desc: ''};
        }
        
        function startGame(gameId) {
            currentGame = gameId;
            resetAdaptiveData(); // Reset stats for the new game
            document.getElementById('gameTitle').textContent = getGameDetails(gameId).name;
            navigateTo('gameInterface');
            nextQuestion();
        }

        function generateQuestion() {
            gameState = { isAnswered: false, userAnswer: null };
            hideMessage();
            document.getElementById('checkAnswerBtn').style.display = 'none';

            const questionGenerators = {
                'conteggio': generateCountingQuestion,
                'addizioni-visual': generateAdditionQuestion,
                'frazioni-visual': generateFractionQuestion
                // Aggiungi qui altre funzioni per i giochi
            };
            
            const generator = questionGenerators[currentGame] || generateCountingQuestion;
            generator();
        }
        
        // --- Game Logic Functions ---
        function generateCountingQuestion() {
            const max = Math.min(5 + adaptiveData.currentDifficulty * 2, 20);
            const count = Math.floor(Math.random() * max) + 1;
            const objects = ['🍎', '🌟', '🚗', '🐱', '🎈'];
            const obj = objects[Math.floor(Math.random() * objects.length)];
            gameState.correctAnswer = count;
            
            let contentHTML = `<div class="question">Quanti ${obj} ci sono?</div><div class="counting-objects">`;
            for(let i=0; i<count; i++) contentHTML += `<div class="counting-object">${obj}</div>`;
            contentHTML += `</div><div class="answers-grid">${generateNumberOptions(count, 4)}</div>`;
            document.getElementById('gameContent').innerHTML = contentHTML;
        }

        function generateAdditionQuestion() {
            const max = Math.min(5 + adaptiveData.currentDifficulty * 2, 20);
            const a = Math.floor(Math.random() * (max/2)) + 1;
            const b = Math.floor(Math.random() * (max/2)) + 1;
            gameState.correctAnswer = a + b;
            
            let contentHTML = `<div class="question">${a} + ${b} = ?</div><div class="answers-grid">${generateNumberOptions(a+b, 4)}</div>`;
            document.getElementById('gameContent').innerHTML = contentHTML;
        }

        function generateFractionQuestion() {
            const denominators = [2, 3, 4, 6, 8];
            const d = denominators[Math.floor(Math.random() * denominators.length)];
            const n = Math.floor(Math.random() * d) + 1;
            gameState.correctAnswer = {n, d};
            
            const angleStep = 360 / d;
            let slicesHTML = '';
            for (let i = 0; i < d; i++) {
                const rotation = angleStep * i;
                const clipPath = `polygon(0% 0%, 100% 0, 100% 100%, 0% 100%)`; // Placeholder, a more complex path would be needed for perfect slices
                slicesHTML += `<div class="pizza-slice" data-slice="${i}" style="transform: rotate(${rotation}deg); clip-path: polygon(50% 50%, 100% 25%, 100% 75%);" onclick="toggleSlice(this)"></div>`;
            }
             
            let pizzaHTML = '';
            for(let i=0; i < d; i++){
                const angle = 360 / d;
                pizzaHTML += `<div class="pizza-slice" style="transform: rotate(${i * angle}deg); --angle: ${angle}deg" onclick="toggleSlice(this)"></div>`
            }
            
            document.getElementById('gameContent').innerHTML = `
                <div class="question">Seleziona ${n} / ${d}</div>
                <div class="fraction-visual">
                    <div class="pizza-container" id="pizzaContainer">${pizzaHTML}</div>
                    <div>Fette selezionate: <span id="selectedSlices">0</span>/${d}</div>
                </div>`;

            ///** MODIFICA: CSS dinamico per le fette di pizza **/
            const sheet = new CSSStyleSheet();
            sheet.replaceSync(`.pizza-slice { clip-path: polygon(50% 50%, 100% 50%, 100% calc(50% + 100px * tan(var(--angle) / 2)), 50% 50%); }`);
            document.adoptedStyleSheets = [sheet];

            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
        }

        function toggleSlice(slice) {
            if(gameState.isAnswered) return;
            slice.classList.toggle('filled');
            const selectedCount = document.querySelectorAll('.pizza-slice.filled').length;
            document.getElementById('selectedSlices').textContent = selectedCount;
        }

        function generateNumberOptions(correct, count) {
            const options = new Set([correct]);
            while (options.size < count) {
                const random = Math.floor(Math.random() * (correct + 5)) + Math.max(1, correct - 5);
                if (random > 0) options.add(random);
            }
            return Array.from(options).sort(() => Math.random() - 0.5)
                .map(num => `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`).join('');
        }

        function selectAnswer(answer) {
            if (gameState.isAnswered) return;
            gameState.userAnswer = answer;
            checkAnswerLogic();
        }

        function checkAnswer() {
             if (gameState.isAnswered) return;
             if (currentGame === 'frazioni-visual') {
                 const selected = document.querySelectorAll('.pizza-slice.filled').length;
                 gameState.userAnswer = selected;
                 checkAnswerLogic();
             }
        }
        
        function checkAnswerLogic() {
            gameState.isAnswered = true;
            let isCorrect = false;

            if (currentGame === 'frazioni-visual') {
                 isCorrect = gameState.userAnswer === gameState.correctAnswer.n;
            } else {
                 isCorrect = gameState.userAnswer === gameState.correctAnswer;
            }
            
            processAnswer(isCorrect);
        }
        
        function processAnswer(isCorrect) {
            adaptiveData.totalQuestions++;
            if (isCorrect) {
                adaptiveData.correctAnswers++;
                adaptiveData.consecutiveCorrect++;
                adaptiveData.consecutiveWrong = 0;
                score += 10 * adaptiveData.currentDifficulty;
                stars += adaptiveData.currentDifficulty;
                showMessage('Corretto! 🎉', 'success');
                if (adaptiveData.consecutiveCorrect >= 3 && adaptiveData.currentDifficulty < adaptiveData.maxDifficulty) {
                    adaptiveData.currentDifficulty++;
                    level = adaptiveData.currentDifficulty;
                    adaptiveData.consecutiveCorrect = 0;
                }
            } else {
                adaptiveData.consecutiveWrong++;
                adaptiveData.consecutiveCorrect = 0;
                showMessage('Sbagliato. Riprova! 💪', 'error');
                if (adaptiveData.consecutiveWrong >= 2 && adaptiveData.currentDifficulty > 1) {
                    adaptiveData.currentDifficulty--;
                    level = adaptiveData.currentDifficulty;
                    adaptiveData.consecutiveWrong = 0;
                }
            }
            
            // Highlight answers
            document.querySelectorAll('.answer-btn').forEach(btn => {
                const btnValue = parseInt(btn.textContent);
                if (btnValue === gameState.correctAnswer) btn.classList.add('correct');
                else if (btnValue === gameState.userAnswer) btn.classList.add('wrong');
                btn.style.pointerEvents = 'none';
            });

            saveProgress();
        }

        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.textContent = text;
            container.className = `message ${type} show`;
        }
        function hideMessage() { document.getElementById('messageContainer').classList.remove('show'); }

        function nextQuestion() { generateQuestion(); }
        function backToHome() { navigateTo('homepage'); }
        function backToGames() { selectClass(currentClass); }

        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            // /** MODIFICA: Registrazione del Service Worker esterno **/
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrato con successo:', registration))
                    .catch(error => console.log('Registrazione Service Worker fallita:', error));
            }
        });
    </script>
</body>
</html>
