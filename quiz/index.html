<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Lab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
    <meta name="theme-color" content="#3B82F6">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EduTech Lab">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* MODIFICA: Assicura che html e body occupino tutta l'altezza per il layout flessibile */
        html, body { height: 100%; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #1a1a1a; min-height: 100vh; overflow-x: hidden; }
        .main-container { min-height: 100vh; position: relative; }
        .animated-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .floating-shape { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.1); animation: float 6s ease-in-out infinite; }
        .floating-shape:nth-child(1) { top: 20%; left: 10%; width: 80px; height: 80px; animation-delay: 0s; }
        .floating-shape:nth-child(2) { top: 40%; left: 80%; width: 60px; height: 60px; animation-delay: 2s; }
        .floating-shape:nth-child(3) { top: 70%; left: 20%; width: 100px; height: 100px; animation-delay: 4s; }
        .floating-shape:nth-child(4) { top: 80%; left: 60%; width: 40px; height: 40px; animation-delay: 1s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(180deg); } }
        .pwa-install { position: fixed; top: 1rem; right: 1rem; background: #4CAF50; color: white; border: none; padding: 0.75rem; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); z-index: 1000; display: none; transition: all 0.3s ease; }
        .header { text-align: center; padding: 2rem; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); margin: 1rem; border-radius: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .header h1 { font-size: 3rem; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .classes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .class-card { background: rgba(255, 255, 255, 0.95); border-radius: 1.5rem; padding: 2rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .class-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .card-emoji { font-size: 4rem; margin-bottom: 1rem; display: block; } .card-title { font-size: 1.3rem; font-weight: bold; }
        .games-section { display: none; padding: 1rem; max-width: 1200px; margin: 0 auto; }
        .nav-btn { background: rgba(255, 255, 255, 0.9); border: none; padding: 0.75rem 1.5rem; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 1rem; cursor: pointer; font-weight: 600; } .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        
        /** MODIFICA: Layout di gioco flessibile per adattarsi allo schermo (LIM/PC) **/
        .game-interface { display: none; flex-direction: column; background: rgba(255, 255, 255, 0.98); border-radius: 2rem; margin: 1rem; padding: 2rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); height: calc(100vh - 2rem); /* Occupa tutta l'altezza disponibile */ }
        .game-header { flex-shrink: 0; /* Impedisce all'header di rimpicciolirsi */ }
        .game-content { flex-grow: 1; /* Fa espandere il contenuto per riempire lo spazio */ overflow-y: auto; /* Aggiunge scroll solo se necessario */ background: #f8f9fa; border-radius: 1rem; padding: 2rem; margin: 1rem 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        div[style*="text-align: center; margin-top: 2rem;"] { flex-shrink: 0; /* Impedisce ai pulsanti di rimpicciolirsi */ }
        
        .question { font-size: 2rem; font-weight: bold; text-align: center; margin-bottom: 2rem; color: #333; }
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; width: 100%; max-width: 600px; }
        .answer-btn { padding: 1.5rem; font-size: 1.5rem; border: 2px solid #ddd; border-radius: 1rem; background: white; cursor: pointer; transition: all 0.3s ease; }
        .answer-btn:hover { background: #f0f4ff; }
        .answer-btn.correct { background: #4CAF50; color: white; border-color: #45a049; }
        .answer-btn.wrong { background: #f44336; color: white; border-color: #d32f2f; }
        .counting-objects { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin: 2rem 0; }
        .counting-object { font-size: 3rem; }

        /** MODIFICA: Stile per il gioco delle frazioni (pizza) **/
        .fraction-visual { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1rem; }
        .pizza-container { position: relative; width: 250px; height: 250px; border-radius: 50%; background: #FDEBD0; border: 3px solid #AF601A; }
        .pizza-slice { position: absolute; width: 125px; height: 125px; background: transparent; transform-origin: 100% 100%; overflow: hidden; }
        .pizza-slice::before { content: ''; position: absolute; width: 125px; height: 125px; background-color: rgba(255, 107, 53, 0.7); border-radius: 125px 0 0 0; transform-origin: 100% 100%; cursor: pointer; transform: rotate(-90deg); }
        .pizza-slice.filled::before { background-color: #FF6B35; }

        .message { padding: 1rem; border-radius: 1rem; margin: 1rem 0; text-align: center; font-weight: bold; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; display: none; }
        .message.show { opacity: 1; transform: translateY(0); display: block; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .classes-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="animated-bg">
        <div class="floating-shape"></div><div class="floating-shape"></div><div class="floating-shape"></div><div class="floating-shape"></div>
    </div>
    <button class="pwa-install" id="installBtn" title="Installa l'app">üì±</button>

    <div class="main-container">
        <div id="homepage">
            <header class="header">
                <h1>üéì EduTech Lab</h1>
                <h2>Pensiero Computazionale per la Scuola Primaria</h2>
                <p>Scegli la tua classe e inizia il viaggio nel mondo del coding!</p>
            </header>
            <div class="classes-grid">
                <div class="class-card" onclick="selectClass(1)">
                    <div class="card-emoji">üå±</div><h3 class="card-title">Classe 1¬™</h3><p class="card-description">I primi passi nel mondo digitale (6-7 anni)</p>
                 </div>
                 <div class="class-card" onclick="selectClass(2)">
                    <div class="card-emoji">üåø</div><h3 class="card-title">Classe 2¬™</h3><p class="card-description">Esploratori digitali curiosi (7-8 anni)</p>
                 </div>
                 <div class="class-card" onclick="selectClass(3)">
                    <div class="card-emoji">üå≥</div><h3 class="card-title">Classe 3¬™</h3><p class="card-description">Logica e primi algoritmi (8-9 anni)</p>
                 </div>
                 <div class="class-card" onclick="selectClass(4)">
                    <div class="card-emoji">üå≤</div><h3 class="card-title">Classe 4¬™</h3><p class="card-description">Algoritmi avanzati (9-10 anni)</p>
                 </div>
                 <div class="class-card" onclick="selectClass(5)">
                    <div class="card-emoji">üå∫</div><h3 class="card-title">Classe 5¬™</h3><p class="card-description">Programmatori junior (10-11 anni)</p>
                 </div>
            </div>
        </div>

        <div id="gamesSection" class="games-section">
            <div class="game-header">
                <h2 id="classTitle">Classe selezionata</h2>
                <button class="nav-btn" onclick="backToHome()">üè† Torna alla Home</button>
            </div>
            <div class="games-grid" id="gamesGrid"></div>
        </div>

        <div id="gameInterface" class="game-interface">
            <div class="game-header">
                <h2 id="gameTitle">Gioco</h2>
                <button class="btn btn-secondary" onclick="backToGames()">üéÆ Torna ai Giochi</button>
            </div>
            <div class="message" id="messageContainer"></div>
            <div class="game-content" id="gameContent"></div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="nextQuestion()">üîÑ Prossima Domanda</button>
                <button class="btn btn-primary" onclick="checkAnswer()" style="display: none;" id="checkAnswerBtn">‚úÖ Verifica Risposta</button>
            </div>
        </div>
    </div>

    <script>
        // Mantenuta la tua struttura originale dello script
        let currentClass = 1;
        let currentGame = '';
        let gameState = {};
        let score = 0, stars = 0, level = 1;

        const classesData = {
            1: { games: [{ id: 'conteggio'}, {id: 'addizioni-visual' }] },
            2: { games: [{ id: 'conteggio'}, {id: 'addizioni-visual' }] },
            3: { games: [{ id: 'conteggio'}, {id: 'addizioni-visual' }] },
            4: { games: [{ id: 'conteggio'}, {id: 'frazioni-visual' }] },
            5: { games: [{ id: 'conteggio'}, {id: 'frazioni-visual' }] }
        };

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
        });

        function selectClass(classNum) {
            currentClass = classNum;
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'block';
            document.getElementById('classTitle').textContent = `Classe ${classNum}¬™`;
            loadGamesForClass(classNum);
        }

        function loadGamesForClass(classNum) {
            const games = classesData[classNum].games;
            const gamesGrid = document.getElementById('gamesGrid');
            gamesGrid.innerHTML = '';
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'class-card'; // Usiamo lo stile che gi√† avevi
                gameCard.onclick = () => startGame(game.id);
                gameCard.innerHTML = `<h3 class="card-title">${game.id}</h3>`;
                gamesGrid.appendChild(gameCard);
            });
        }

        function startGame(gameId) {
            currentGame = gameId;
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'flex'; // MODIFICA: display:flex per il layout verticale
            document.getElementById('gameTitle').textContent = gameId;
            generateQuestion();
        }

        function generateQuestion() {
            gameState.isAnswered = false;
            document.getElementById('checkAnswerBtn').style.display = 'none';
            hideMessage();

            switch (currentGame) {
                case 'conteggio': generateCountingQuestion(); break;
                case 'addizioni-visual': generateAdditionQuestion(); break;
                case 'frazioni-visual': generateFractionQuestion(); break; // MODIFICA: Attivato il gioco frazioni
                default: generateCountingQuestion();
            }
        }
        
        function generateCountingQuestion() {
            const count = Math.floor(Math.random() * 9) + 1;
            gameState.correctAnswer = count;
            const objects = ['üçé', 'üåü', 'üöó', 'üê±', 'üéà'];
            const selectedObject = objects[Math.floor(Math.random() * objects.length)];
            let visualHTML = '';
            for(let i=0; i<count; i++) visualHTML += `<span class="counting-object">${selectedObject}</span>`;
            document.getElementById('gameContent').innerHTML = `
                <div class="question">Quanti oggetti vedi?</div>
                <div class="counting-objects">${visualHTML}</div>
                <div class="answers-grid">${generateNumberOptions(count, 4)}</div>`;
        }
        
        function generateAdditionQuestion(){
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            gameState.correctAnswer = a + b;
            document.getElementById('gameContent').innerHTML = `
                <div class="question">${a} + ${b} = ?</div>
                <div class="answers-grid">${generateNumberOptions(a + b, 4)}</div>`;
        }
        
        /** MODIFICA: Funzione per il gioco delle frazioni (pizza cliccabile) **/
        function generateFractionQuestion() {
            const d = [2, 3, 4, 6, 8][Math.floor(Math.random() * 5)];
            const n = Math.floor(Math.random() * d) + 1;
            gameState.correctAnswer = { n, d };
            
            let slicesHTML = '';
            const angle = 360 / d;
            for (let i = 0; i < d; i++) {
                slicesHTML += `<div class="pizza-slice" style="transform: rotate(${i * angle}deg);"><div class="slice-interactive" style="transform: skew(${90-angle}deg);" onclick="toggleSlice(this)"></div></div>`;
            }
            if (angle < 90) { // Fix per il rendering di fette piccole
                const fixStyle = document.createElement('style');
                fixStyle.id = 'pizza-style-fix';
                fixStyle.innerHTML = `.pizza-slice .slice-interactive { transform: rotate(${(90-angle)/2}deg) skew(${90-angle}deg); }`;
                document.head.appendChild(fixStyle);
            }

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Seleziona ${n} / ${d}</div>
                <div class="fraction-visual">
                    <div class="pizza-container">${slicesHTML}</div>
                    <div>Fette selezionate: <span id="selectedSlices">0</span>/${d}</div>
                </div>`;
            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
        }

        function toggleSlice(sliceElement) {
            if(gameState.isAnswered) return;
            sliceElement.parentElement.classList.toggle('filled');
            const selectedCount = document.querySelectorAll('.pizza-slice.filled').length;
            document.getElementById('selectedSlices').textContent = selectedCount;
        }

        function generateNumberOptions(correct, count) {
            const options = new Set([correct]);
            while (options.size < count) {
                const random = Math.max(1, correct + Math.floor(Math.random() * 7) - 3);
                options.add(random);
            }
            return [...options].sort(() => Math.random() - 0.5)
                .map(num => `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`).join('');
        }

        function selectAnswer(answer) {
            if(gameState.isAnswered) return;
            gameState.userAnswer = answer;
            checkAnswerLogic();
        }

        function checkAnswer() {
            if(gameState.isAnswered) return;
            if(currentGame === 'frazioni-visual') {
                gameState.userAnswer = document.querySelectorAll('.pizza-slice.filled').length;
                checkAnswerLogic();
            }
        }
        
        function checkAnswerLogic() {
            if(gameState.isAnswered) return;
            gameState.isAnswered = true;
            let isCorrect = false;

            if(currentGame === 'frazioni-visual') {
                isCorrect = gameState.userAnswer === gameState.correctAnswer.n;
            } else {
                isCorrect = gameState.userAnswer === gameState.correctAnswer;
            }
            
            if(isCorrect) {
                showMessage('Corretto!', 'success');
            } else {
                showMessage('Sbagliato!', 'error');
            }
        }

        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.textContent = text;
            container.className = `message ${type} show`;
        }
        function hideMessage() { document.getElementById('messageContainer').classList.remove('show'); }

        function nextQuestion() {
            const fixStyle = document.getElementById('pizza-style-fix');
            if(fixStyle) fixStyle.remove(); // Rimuove stili temporanei della pizza
            generateQuestion(); 
        }
        function backToHome() {
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('homepage').style.display = 'block';
        }
        function backToGames() {
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'block';
        }

        /** MODIFICA: Registrazione del Service Worker esterno per la PWA offline **/
        document.addEventListener('DOMContentLoaded', function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker registrato.'))
                    .catch(err => console.error('Registrazione Service Worker fallita:', err));
            }
        });
    </script>
</body>
</html>
