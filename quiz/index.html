<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Lab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRWR1VGVjaCBMYWIiLCJzaG9ydF9uYW1lIjoiRWR1VGVjaCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjNjY3ZWVhIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1UQXdJaUJvWldsbmFIUTlJakV3TUNJaVBqeDBaWGgwSUhrOUlqVXdJaUIzWVdkcFRrNS9wUzRLVkZQNyIsInNpemVzIjoiMTAweDEwMCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            --button-size: 50px;
            --font-size-large: 1.8rem;
            --font-size-medium: 1.1rem;
            --spacing: 1.5rem;
        }

        /* ================ OTTIMIZZAZIONI 16:9 LAYOUT ================ */
        /* Media query specifico per aspect ratio 16:9 e simili */
        @media screen and (aspect-ratio: 16/9), 
               screen and (min-aspect-ratio: 16/10) and (max-aspect-ratio: 19/10) {
            body {
                --header-padding: 0.8rem;
                --grid-gap: 0.8rem;
                --card-padding: 1rem;
                --font-size-h1: 1.8rem;
                --font-size-h2: 1.1rem;
                --font-size-p: 0.9rem;
                --container-margin: 0.5rem;
                --stats-margin: 0.5rem;
                --game-padding: 1rem;
            }
            
            .header {
                padding: var(--header-padding) !important;
                margin: var(--container-margin) !important;
            }
            
            .header h1 {
                font-size: var(--font-size-h1) !important;
                margin-bottom: 0.3rem !important;
            }
            
            .header h2 {
                font-size: var(--font-size-h2) !important;
                margin-bottom: 0.3rem !important;
            }
            
            .header p {
                font-size: var(--font-size-p) !important;
            }
            
            .classes-grid {
                gap: var(--grid-gap) !important;
                padding: var(--container-margin) !important;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
            }
            
            .class-card {
                padding: var(--card-padding) !important;
            }
            
            .card-emoji {
                font-size: 2rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .card-title {
                font-size: 1.2rem !important;
                margin-bottom: 0.3rem !important;
            }
            
            .card-description {
                font-size: 0.85rem !important;
                margin-bottom: 0.8rem !important;
            }
            
            .stats-bar {
                margin: var(--stats-margin) !important;
                gap: 0.5rem !important;
            }
            
            .stat-item {
                padding: 0.5rem 1rem !important;
                font-size: 0.9rem !important;
            }
            
            .game-container {
                padding: var(--game-padding) !important;
                margin: var(--container-margin) !important;
            }
            
            .question {
                font-size: 1.1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .fraction-visual {
                gap: 1rem !important;
            }
            
            .pizza-container {
                width: 150px !important;
                height: 150px !important;
            }
            
            .options {
                gap: 0.8rem !important;
                margin: 1rem 0 !important;
            }
            
            .nav-controls {
                padding: 0.8rem !important;
                gap: 0.8rem !important;
            }
        }
        /* ================ END OTTIMIZZAZIONI 16:9 ================ */

        .background-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .floating-shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .floating-shape:nth-child(1) { top: 20%; left: 10%; width: 80px; height: 80px; animation-delay: 0s; }
        .floating-shape:nth-child(2) { top: 40%; left: 80%; width: 60px; height: 60px; animation-delay: 2s; }
        .floating-shape:nth-child(3) { top: 70%; left: 20%; width: 100px; height: 100px; animation-delay: 4s; }
        .floating-shape:nth-child(4) { top: 80%; left: 60%; width: 40px; height: 40px; animation-delay: 1s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* ================ DEVICE DETECTION STYLES ================ */
        /* Device info indicator */
        .device-info {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Device-specific adaptations */
        .device-lim {
            --button-size: 60px;
            --font-size-large: 2rem;
            --font-size-medium: 1.2rem;
            --spacing: 2rem;
        }

        .device-tablet {
            --button-size: 50px;
            --font-size-large: 1.8rem;
            --font-size-medium: 1.1rem;
            --spacing: 1.5rem;
        }

        .device-desktop {
            --button-size: 45px;
            --font-size-large: 1.6rem;
            --font-size-medium: 1rem;
            --spacing: 1rem;
        }

        .device-mobile {
            --button-size: 40px;
            --font-size-large: 1.4rem;
            --font-size-medium: 0.9rem;
            --spacing: 0.8rem;
        }
        /* ================ END DEVICE DETECTION STYLES ================ */

        /* PWA Install Button */
        .pwa-install {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        }

        .pwa-install:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        /* Download App Button */
        .download-app {
            position: fixed;
            top: 1rem;
            right: 5rem;
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .download-app:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
        }

        .main-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header - Ottimizzato per 16:9 */
        .header {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 1rem;
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.4rem;
        }

        .header h2 {
            font-size: 1.3rem;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        .header p {
            color: #6B7280;
            font-size: 1rem;
        }

        /* Stats Bar - Ottimizzato */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stat-stars { background: #FEF3C7; color: #92400E; }
        .stat-score { background: #D1FAE5; color: #065F46; }
        .stat-level { background: #E0E7FF; color: #3730A3; }

        /* Classes Grid - Ottimizzato per 16:9 */
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.2rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .class-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .class-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .card-emoji {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .card-badges {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            background: #EFF6FF;
            color: #1E40AF;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .badge.math { background: #FEF3C7; color: #92400E; }
        .badge.coding { background: #D1FAE5; color: #065F46; }
        .badge.thinking { background: #E0E7FF; color: #3730A3; }

        /* Navigation Controls - Ottimizzato */
        .nav-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            margin: 1rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .reset-btn:hover {
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        /* Games List - Ottimizzato */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            padding: 1rem;
            margin: 0 auto;
            max-width: 1200px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #4CAF50;
        }

        .game-card h3 {
            font-size: 1.1rem;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }

        .game-card p {
            color: #6B7280;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Game Container - Ottimizzato per 16:9 */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 1rem;
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
        }

        .question {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 1.5rem;
        }

        /* Game Elements - Ottimizzati */
        .visual-area {
            background: #F0F9FF;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .option {
            background: #FEF3C7;
            border: 3px solid #F59E0B;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            background: #FED7AA;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .option.correct {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }

        .option.wrong {
            background: #f44336;
            border-color: #da190b;
            color: white;
        }

        /* Pattern Game */
        .pattern-area {
            background: #f3f4f6;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            min-height: 100px;
        }

        .pattern-items {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pattern-item {
            background: #EFF6FF;
            border: 2px solid #3B82F6;
            border-radius: 0.5rem;
            padding: 0.8rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pattern-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .pattern-option {
            background: #FEF3C7;
            border: 3px solid #F59E0B;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pattern-option:hover {
            background: #FED7AA;
            transform: translateY(-2px);
        }

        .pattern-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .pattern-item.correct {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        /* Sequence Game */
        .sequence-area {
            background: #f3f4f6;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            min-height: 100px;
        }

        .sequence-items {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .sequence-item {
            background: #EFF6FF;
            border: 2px solid #3B82F6;
            border-radius: 0.5rem;
            padding: 0.8rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sequence-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .sequence-option {
            background: #FEF3C7;
            border: 3px solid #F59E0B;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sequence-option:hover {
            background: #FED7AA;
            transform: translateY(-2px);
        }

        /* Fractions Game - Ottimizzato per 16:9 */
        .fraction-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .pizza-container {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .pizza-slice {
            position: absolute;
            width: 90px;
            height: 90px;
            border: 3px solid #FF6B35;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pizza-slice.filled {
            background: #FF6B35;
        }

        .pizza-slice:hover {
            transform: scale(1.05);
        }

        /* Messages */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .message.success { border-left: 4px solid #4CAF50; }
        .message.error { border-left: 4px solid #f44336; }
        .message.info { border-left: 4px solid #2196F3; }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive optimizations - Potenziato per 16:9 */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .header h2 { font-size: 1.1rem; }
            .classes-grid { grid-template-columns: 1fr; }
            .games-grid { grid-template-columns: 1fr; }
            .options { grid-template-columns: repeat(2, 1fr); }
            .nav-controls { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .header { padding: 1rem; margin: 0.5rem; }
            .header h1 { font-size: 1.8rem; }
            .game-container { padding: 1rem; margin: 0.5rem; }
            .pizza-container { width: 150px; height: 150px; }
            .pizza-slice { width: 75px; height: 75px; }
        }

        /* Hidden by default */
        .class-games, .game-screen {
            display: none;
        }

        /* Info Project Section */
        .info-project {
            background: linear-gradient(135deg, white 0%, #EFF6FF 100%);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            color: #1F2937;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-card p {
            color: #6B7280;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .class-card, .game-card, .game-container {
                border: 2px solid #000;
            }
            
            .option {
                border-width: 3px;
            }
        }
    </style>
</head>
<body>
    <!-- Device Info Display -->
    <div class="device-info" id="deviceInfo">Loading...</div>

    <!-- Background Animation -->
    <div class="background-shapes">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- PWA Install Button -->
    <button class="pwa-install" id="installBtn" title="Installa l'app">üì±</button>

    <!-- Download App Button -->
    <button class="download-app" id="downloadBtn" title="Scarica l'app">üíæ</button>

    <div class="main-container">
        <!-- Homepage: Scelta Classe -->
        <div id="homepage">
            <header class="header">
                <h1>üéì EduTech Lab</h1>
                <h2>Pensiero Computazionale per la Scuola Primaria</h2>
                <p>Scegli la tua classe e inizia il viaggio nel mondo del coding!</p>
            </header>

            <!-- Stats Bar (visible when there are points) -->
            <div id="stats-bar" class="stats-bar" style="display: none;">
                <div class="stat-item stat-stars">‚≠ê <span id="stars-count">0</span> stelle</div>
                <div class="stat-item stat-score">üèÜ <span id="score-count">0</span> punti</div>
                <div class="stat-item stat-level">üß† Livello <span id="level-count">1</span></div>
                <button class="nav-btn reset-btn" onclick="resetProgress()">üîÑ Reset</button>
            </div>

            <div class="classes-grid">
                <div class="class-card" onclick="selectClass(1)">
                    <div class="card-emoji">üå±</div>
                    <h3 class="card-title">Classe 1¬™</h3>
                    <p class="card-description">I primi passi nel mondo digitale (6-7 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Conteggio</span>
                        <span class="badge coding">Sequenze</span>
                        <span class="badge thinking">Pattern</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 4 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(2)">
                    <div class="card-emoji">üåø</div>
                    <h3 class="card-title">Classe 2¬™</h3>
                    <p class="card-description">Esploratori digitali curiosi (7-8 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Operazioni</span>
                        <span class="badge coding">Debug</span>
                        <span class="badge thinking">Pattern</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 6 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(3)">
                    <div class="card-emoji">üå≥</div>
                    <h3 class="card-title">Classe 3¬™</h3>
                    <p class="card-description">Logica e ragionamento (8-9 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Frazioni</span>
                        <span class="badge coding">Condizioni</span>
                        <span class="badge thinking">Debug</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 7 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(4)">
                    <div class="card-emoji">üå≤</div>
                    <h3 class="card-title">Classe 4¬™</h3>
                    <p class="card-description">Algoritmi avanzati (9-10 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Variabili</span>
                        <span class="badge coding">Algoritmi</span>
                        <span class="badge thinking">Debug</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 7 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(5)">
                    <div class="card-emoji">üå∫</div>
                    <h3 class="card-title">Classe 5¬™</h3>
                    <p class="card-description">Programmatori junior (10-11 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Statistiche</span>
                        <span class="badge coding">Progetti</span>
                        <span class="badge thinking">Collaborazione</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 8 Giochi attivi</div>
                </div>
            </div>

            <!-- Info Project Section -->
            <div class="info-project">
                <h2 style="text-align: center; color: #1F2937; margin-bottom: 1rem;">
                    üöÄ Progetto EduTech Lab
                </h2>
                <p style="text-align: center; color: #6B7280; margin-bottom: 1.5rem;">
                    Una piattaforma innovativa per l'apprendimento del Pensiero Computazionale nella Scuola Primaria
                </p>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>üéØ Obiettivi</h3>
                        <p>Sviluppare competenze di problem solving, logica e creativit√† attraverso attivit√† interattive e coinvolgenti</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>üéÆ Metodologia</h3>
                        <p>Apprendimento basato sul gioco (Game-Based Learning) con progressione graduale delle competenze</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>üì± Tecnologia</h3>
                        <p>PWA (Progressive Web App) accessibile da qualsiasi dispositivo, anche offline</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>üë®‚Äçüéì Autore</h3>
                        <p>Sviluppato per docenti e formatori di Pensiero Computazionale, Coding e Robotica Educativa</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Games List for Selected Class -->
        <div id="class-games" class="class-games">
            <div class="nav-controls">
                <button class="nav-btn" onclick="goHome()">üè† Home</button>
                <h2 id="class-title">Classe Selezionata</h2>
            </div>
            
            <div id="games-grid" class="games-grid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <div class="nav-controls">
                <button class="nav-btn" onclick="goHome()">üè† Home</button>
                <button class="nav-btn" onclick="goBackToClass()">üìö Classe</button>
                <h2 id="game-title">Gioco</h2>
            </div>
            
            <div id="game-container" class="game-container">
                <div id="gameContent">
                    <!-- Populated by JavaScript -->
                </div>
                
                <div class="nav-controls">
                    <button id="checkAnswerBtn" class="nav-btn" onclick="checkAnswer()" style="display: none;">‚úÖ Controlla</button>
                    <button id="nextQuestionBtn" class="nav-btn" onclick="nextQuestion()" style="display: none;">‚û°Ô∏è Prossima</button>
                    <button id="newGameBtn" class="nav-btn" onclick="startGame(currentGame)" style="display: none;">üîÑ Nuovo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================ DEVICE DETECTION SYSTEM ================
        class DeviceDetector {
            constructor() {
                this.deviceInfo = this.detectDevice();
                this.displayDeviceInfo();
                this.applyDeviceStyles();
            }

            detectDevice() {
                const userAgent = navigator.userAgent;
                const screen = window.screen;
                const viewport = {
                    width: window.innerWidth,
                    height: window.innerHeight
                };

                // Screen size detection
                const screenSize = Math.max(screen.width, screen.height);
                let deviceType = 'desktop';

                if (screenSize >= 2048 || (screen.width >= 1600 && screen.height >= 1200)) {
                    deviceType = 'lim'; // Large Interactive Monitor
                } else if (screenSize >= 1024 && screenSize < 2048) {
                    deviceType = 'tablet';
                } else if (screenSize < 1024) {
                    deviceType = 'mobile';
                }

                // Touch support detection
                const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                return {
                    type: deviceType,
                    screenWidth: screen.width,
                    screenHeight: screen.height,
                    viewportWidth: viewport.width,
                    viewportHeight: viewport.height,
                    touchSupport: touchSupport,
                    userAgent: userAgent,
                    pixelRatio: window.devicePixelRatio || 1,
                    orientation: viewport.width > viewport.height ? 'landscape' : 'portrait'
                };
            }

            displayDeviceInfo() {
                const infoElement = document.getElementById('deviceInfo');
                infoElement.textContent = `${this.deviceInfo.type.toUpperCase()} - ${this.deviceInfo.screenWidth}√ó${this.deviceInfo.screenHeight} - ${this.deviceInfo.orientation}`;
            }

            applyDeviceStyles() {
                const body = document.body;
                body.className = `device-${this.deviceInfo.type}`;
                
                // Apply device-specific CSS custom properties
                const root = document.documentElement;
                
                switch(this.deviceInfo.type) {
                    case 'lim':
                        root.style.setProperty('--button-size', '70px');
                        root.style.setProperty('--font-size-large', '2.5rem');
                        root.style.setProperty('--font-size-medium', '1.4rem');
                        root.style.setProperty('--spacing', '2.5rem');
                        break;
                    case 'tablet':
                        root.style.setProperty('--button-size', '55px');
                        root.style.setProperty('--font-size-large', '2rem');
                        root.style.setProperty('--font-size-medium', '1.2rem');
                        root.style.setProperty('--spacing', '1.8rem');
                        break;
                    case 'mobile':
                        root.style.setProperty('--button-size', '45px');
                        root.style.setProperty('--font-size-large', '1.6rem');
                        root.style.setProperty('--font-size-medium', '1rem');
                        root.style.setProperty('--spacing', '1rem');
                        break;
                    default: // desktop
                        root.style.setProperty('--button-size', '50px');
                        root.style.setProperty('--font-size-large', '1.8rem');
                        root.style.setProperty('--font-size-medium', '1.1rem');
                        root.style.setProperty('--spacing', '1.5rem');
                }

                // Touch-specific adjustments
                if (this.deviceInfo.touchSupport) {
                    root.style.setProperty('--touch-target-size', '44px');
                    body.classList.add('touch-device');
                }
            }
        }

        // Initialize device detection
        const deviceDetector = new DeviceDetector();
        // ================ END DEVICE DETECTION ================

        // Game State and Data
        let gameState = {
            currentClass: null,
            currentGame: null,
            score: parseInt(localStorage.getItem('edutech-score') || '0'),
            stars: parseInt(localStorage.getItem('edutech-stars') || '0'),
            level: parseInt(localStorage.getItem('edutech-level') || '1'),
            streakCount: 0,
            totalQuestions: 0,
            correctAnswers: 0,
            currentQuestion: null
        };

        // Classes Configuration
        const classesData = {
            1: {
                name: "Prima Primaria",
                emoji: "üå±",
                description: "I primi passi",
                age: "6-7 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Visuale', description: 'Conta oggetti fino a 10' },
                    { id: 'pattern-riconoscimento', name: 'üé® Riconosci il Pattern', description: 'Sequenze semplici di colori e forme' },
                    { id: 'addizioni-visual', name: '‚ûï Prime Addizioni', description: 'Somme fino a 10 con supporto visivo' },
                    { id: 'sequenze-logiche', name: 'üîÑ Sequenze Logiche', description: 'Ordina e continua le sequenze' }
                ]
            },
            2: {
                name: "Seconda Primaria",
                emoji: "üåø",
                description: "Esploratori digitali",
                age: "7-8 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Avanzato', description: 'Conta e raggruppa fino a 20' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Operazioni Entro 20', description: 'Calcoli pi√π complessi' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Prime Tabelline', description: 'Tabellina del 2, 5 e 10' },
                    { id: 'frazioni-visual', name: 'üçï Prime Frazioni', description: 'Met√†, terzi e quarti' },
                    { id: 'pattern-riconoscimento', name: 'üîç Riconosco i Pattern', description: 'Sequenze pi√π complesse' },
                    { id: 'algoritmi-semplici', name: 'üìù I Miei Primi Algoritmi', description: 'Istruzioni passo-passo' }
                ]
            },
            3: {
                name: "Terza Primaria",
                emoji: "üå≥",
                description: "Logica e ragionamento",
                age: "8-9 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Strategie di Conteggio', description: 'Metodi intelligenti per contare' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Matematica Mentale', description: 'Calcoli rapidi a mente' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Tutte le Tabelline', description: 'Padronanza delle tabelline' },
                    { id: 'frazioni-visual', name: 'üçï Frazioni in Azione', description: 'Operazioni con le frazioni' },
                    { id: 'addizioni-visual', name: '‚ûï Addizioni Colorate', description: 'Somme con supporto visivo' },
                    { id: 'condizioni-base', name: '‚ùì Se... Allora...', description: 'Prime condizioni logiche' },
                    { id: 'debugging-visuale', name: 'üêõ Debug Master', description: 'Debugging di algoritmi' }
                ]
            },
            4: {
                name: "Quarta Primaria",
                emoji: "üå≤",
                description: "Algoritmi avanzati",
                age: "9-10 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Professionale', description: 'Strategie avanzate di conteggio' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Calcoli Complessi', description: 'Operazioni con numeri grandi' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Tabelline Complete', description: 'Tutte le tabelline fino al 10' },
                    { id: 'frazioni-visual', name: 'üçï Frazioni Interattive', description: 'Visualizza e opera con le frazioni' },
                    { id: 'addizioni-visual', name: '‚ûï Aritmetica Avanzata', description: 'Operazioni con numeri decimali' },
                    { id: 'variabili-semplici', name: 'üì¶ Le Mie Prime Variabili', description: 'Contenitori per i dati' },
                    { id: 'algoritmi-avanzati', name: 'üß† Algoritmi Intelligenti', description: 'Strategie di risoluzione complesse' },
                    { id: 'debugging-visuale', name: 'üêõ Debug Expert', description: 'Debugging avanzato' }
                ]
            },
            5: {
                name: "Quinta Primaria",
                emoji: "üå∫",
                description: "Programmatori junior",
                age: "10-11 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Esperto', description: 'Metodi di conteggio combinatorio' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Matematica Superiore', description: 'Operazioni con tutti i numeri' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Moltiplicazioni Expert', description: 'Calcoli rapidi e trucchi' },
                    { id: 'frazioni-visual', name: 'üçï Frazioni Master', description: 'Operazioni con frazioni' },
                    { id: 'statistica-base', name: 'üìä I Miei Primi Grafici', description: 'Raccogli e analizza dati' },
                    { id: 'variabili-semplici', name: 'üì¶ Variabili Avanzate', description: 'Programmazione con variabili' },
                    { id: 'algoritmi-avanzati', name: 'üß† Algoritmi Pro', description: 'Ottimizzazione e ricerca' },
                    { id: 'progetti-completi', name: 'üéÆ Crea il Tuo Gioco', description: 'Progetti completi con interfaccia' },
                    { id: 'collaborazione-digitale', name: 'ü§ù Coding di Squadra', description: 'Progetti collaborativi' }
                ]
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStatsDisplay();
            
            // Check if there are saved stats to show stats bar
            if (gameState.score > 0 || gameState.stars > 0) {
                document.getElementById('stats-bar').style.display = 'flex';
            }
        });

        // PWA Installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Download App functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            // Crea il contenuto HTML completo
            const htmlContent = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Lab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
</head>
<body>
    ${document.documentElement.innerHTML}
</body>
</html>`;
            
            // Crea il file blob
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Crea link per il download
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'edutech-lab-giochi.html';
            downloadLink.style.display = 'none';
            
            // Aggiungi al DOM, clicca e rimuovi
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            // Mostra messaggio di successo
            showMessage('üéâ App scaricata! Apri il file per giocare offline!', 'success');
        });

        // Navigation Functions
        function selectClass(classNumber) {
            gameState.currentClass = classNumber;
            showClassGames(classNumber);
        }

        function showClassGames(classNumber) {
            const classData = classesData[classNumber];
            
            // Hide homepage and show class games
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('class-games').style.display = 'block';
            document.getElementById('game-screen').style.display = 'none';
            
            // Update title
            document.getElementById('class-title').textContent = `${classData.emoji} ${classData.name}`;
            
            // Populate games
            const gamesContainer = document.getElementById('games-grid');
            gamesContainer.innerHTML = '';
            
            classData.games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.onclick = () => startGame(game.id);
                
                gameCard.innerHTML = `
                    <h3>${game.name}</h3>
                    <p>${game.description}</p>
                `;
                
                gamesContainer.appendChild(gameCard);
            });
        }

        function goHome() {
            document.getElementById('homepage').style.display = 'block';
            document.getElementById('class-games').style.display = 'none';
            document.getElementById('game-screen').style.display = 'none';
            gameState.currentClass = null;
            gameState.currentGame = null;
        }

        function goBackToClass() {
            if (gameState.currentClass) {
                showClassGames(gameState.currentClass);
            } else {
                goHome();
            }
        }

        // Game Functions
        function startGame(gameId) {
            gameState.currentGame = gameId;
            gameState.totalQuestions = 0;
            gameState.correctAnswers = 0;
            gameState.streakCount = 0;
            
            // Show game screen
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('class-games').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // Find game name
            const classData = classesData[gameState.currentClass];
            const game = classData.games.find(g => g.id === gameId);
            document.getElementById('game-title').textContent = game.name;
            
            // Load appropriate game
            loadGame(gameId);
        }

        function loadGame(gameId) {
            // Reset button states
            document.getElementById('checkAnswerBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('newGameBtn').style.display = 'none';
            
            switch(gameId) {
                case 'conteggio':
                    loadCountingGame();
                    break;
                case 'operazioni-entro-20':
                    loadMathGame();
                    break;
                case 'pattern-riconoscimento':
                    loadPatternGame();
                    break;
                case 'sequenze-logiche':
                    loadSequenceGame();
                    break;
                case 'frazioni-visual':
                    loadFractionsGame();
                    break;
                case 'addizioni-visual':
                    loadAdditionGame();
                    break;
                case 'tabelline-base':
                    loadMultiplicationGame();
                    break;
                default:
                    loadDefaultGame(gameId);
            }
        }

        // IMPROVED: Counting Game with visual dots
        function loadCountingGame() {
            const count = Math.floor(Math.random() * 10) + 1;
            gameState.currentQuestion = { correct: count };

            let dots = '';
            for(let i = 0; i < count; i++) {
                dots += '<span style="font-size: 2rem; margin: 0.2rem;">üî¥</span>';
            }

            const options = [count, count + 1, count - 1, count + 2]
                .filter(n => n > 0)
                .sort(() => Math.random() - 0.5)
                .slice(0, 4);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Quanti cerchi rossi vedi?</div>
                <div class="visual-area">
                    ${dots}
                </div>
                <div class="options">
                    ${options.map(num => `<div class="option" onclick="selectAnswer(${num})">${num}</div>`).join('')}
                </div>
            `;
        }

        // IMPROVED: Math Game with visual support
        function loadMathGame() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const sum = num1 + num2;
            gameState.currentQuestion = { correct: sum };

            const visual1 = 'üü¶'.repeat(num1);
            const visual2 = 'üü®'.repeat(num2);

            const options = [sum, sum + 1, sum - 1, sum + 2]
                .filter(n => n > 0)
                .sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Calcola la somma:</div>
                <div class="visual-area">
                    <div style="margin: 1rem 0;">
                        <div><strong>${num1} quadrati blu:</strong></div>
                        <div>${visual1}</div>
                    </div>
                    <div style="font-size: 2rem; margin: 1rem;">‚ûï</div>
                    <div style="margin: 1rem 0;">
                        <div><strong>${num2} quadrati gialli:</strong></div>
                        <div>${visual2}</div>
                    </div>
                    <div style="font-size: 2rem; margin: 1rem;">üü∞</div>
                    <div><strong>Totale: ?</strong></div>
                </div>
                <div class="options">
                    ${options.map(num => `<div class="option" onclick="selectAnswer(${num})">${num}</div>`).join('')}
                </div>
            `;
        }

        // IMPROVED: Pattern Game with colorful shapes
        function loadPatternGame() {
            const patterns = [
                { sequence: ['üî¥', 'üîµ', 'üî¥', 'üîµ'], next: 'üî¥', description: 'rosso-blu-rosso-blu' },
                { sequence: ['‚≠ê', '‚≠ê', 'üåô', '‚≠ê', '‚≠ê'], next: 'üåô', description: 'stella-stella-luna' },
                { sequence: ['üçé', 'üçå', 'üçä', 'üçé', 'üçå'], next: 'üçä', description: 'mela-banana-arancia' },
                { sequence: ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£'], next: '3Ô∏è‚É£', description: '1-2-3' },
                { sequence: ['üî∫', '‚≠ï', 'üî∏', 'üî∫', '‚≠ï'], next: 'üî∏', description: 'triangolo-cerchio-rombo' }
            ];
            
            const selectedPattern = patterns[Math.floor(Math.random() * patterns.length)];
            gameState.currentQuestion = { correct: selectedPattern.next };

            const wrongOptions = ['üî¥', 'üîµ', '‚≠ê', 'üåô', 'üçé', 'üçå', 'üçä', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', 'üî∫', '‚≠ï', 'üî∏']
                .filter(item => item !== selectedPattern.next)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const options = [selectedPattern.next, ...wrongOptions].sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Quale elemento continua il pattern?</div>
                <div class="pattern-area">
                    <div class="pattern-items">
                        ${selectedPattern.sequence.map(item => `<div class="pattern-item">${item}</div>`).join('')}
                        <div class="pattern-item" style="background: #FEF3C7; border: 2px dashed #F59E0B;">‚ùì</div>
                    </div>
                </div>
                <div style="background: #EFF6FF; padding: 1rem; border-radius: 1rem; margin: 1rem 0; text-align: center;">
                    <strong>üí° Suggerimento:</strong> Osserva la sequenza ${selectedPattern.description}
                </div>
                <div class="pattern-options">
                    ${options.map(item => `<div class="pattern-option" onclick="selectPatternAnswer('${item}')">${item}</div>`).join('')}
                </div>
            `;
        }

        // IMPROVED: Sequence Game with colorful patterns
        function loadSequenceGame() {
            const patterns = [
                { sequence: ['üî¥', 'üîµ', 'üî¥', 'üîµ'], next: 'üî¥', description: 'rosso-blu-rosso-blu' },
                { sequence: ['‚≠ê', '‚≠ê', 'üåô', '‚≠ê', '‚≠ê'], next: 'üåô', description: 'stella-stella-luna' },
                { sequence: ['üçé', 'üçå', 'üçä', 'üçé', 'üçå'], next: 'üçä', description: 'mela-banana-arancia' },
                { sequence: ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£'], next: '3Ô∏è‚É£', description: '1-2-3' },
                { sequence: ['üî∫', '‚≠ï', 'üî∏', 'üî∫', '‚≠ï'], next: 'üî∏', description: 'triangolo-cerchio-rombo' }
            ];
            
            const selectedPattern = patterns[Math.floor(Math.random() * patterns.length)];
            gameState.currentQuestion = { correct: selectedPattern.next };

            const wrongOptions = ['üî¥', 'üîµ', '‚≠ê', 'üåô', 'üçé', 'üçå', 'üçä', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', 'üî∫', '‚≠ï', 'üî∏']
                .filter(item => item !== selectedPattern.next)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const options = [selectedPattern.next, ...wrongOptions].sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Completa la sequenza logica!</div>
                <div class="sequence-area">
                    <div class="sequence-items">
                        ${selectedPattern.sequence.map(item => `<div class="sequence-item">${item}</div>`).join('')}
                        <div class="sequence-item" style="background: #FEF3C7; border: 2px dashed #F59E0B;">‚ùì</div>
                    </div>
                </div>
                <div style="background: #EFF6FF; padding: 1rem; border-radius: 1rem; margin: 1rem 0; text-align: center;">
                    <strong>üí° Rifletti:</strong> Quale elemento manca nella sequenza ${selectedPattern.description}?
                </div>
                <div class="sequence-options">
                    ${options.map(item => `<div class="sequence-option" onclick="selectAnswer('${item}')">${item}</div>`).join('')}
                </div>
            `;
        }

        // UPDATED: Fractions Game - Interactive Pizza Fractions
        function loadFractionsGame() {
            const denominators = gameState.currentClass >= 3 ? [2, 3, 4, 6, 8, 12] : [2, 3, 4, 6, 8];
            const denominator = denominators[Math.floor(Math.random() * denominators.length)];
            const numerator = Math.floor(Math.random() * denominator) + 1;
            
            gameState.currentQuestion = {
                numerator: numerator,
                denominator: denominator
            };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Seleziona ${numerator}/${denominator} della pizza!</div>
                <div class="fraction-visual">
                    <div class="pizza-container" id="pizzaContainer">
                        ${Array(denominator).fill(0).map((_, i) => 
                            `<div class="pizza-slice" data-slice="${i}" onclick="toggleSlice(this)"></div>`
                        ).join('')}
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <div>Fette selezionate: <span id="selectedSlices">0</span>/${denominator}</div>
                        <div>Frazione: <span id="currentFraction">0/${denominator}</span></div>
                    </div>
                </div>
                <div style="background: #FEF3C7; padding: 1rem; border-radius: 1rem; margin: 1rem 0; text-align: center;">
                    <strong>üí° Istruzioni:</strong> Clicca sulle fette di pizza per selezionarle. Devi selezionare esattamente ${numerator} fette su ${denominator} totali!
                </div>
            `;
            
            // Position pizza slices
            const slices = document.querySelectorAll('.pizza-slice');
            slices.forEach((slice, index) => {
                const angle = (360 / denominator) * index;
                slice.style.transform = `rotate(${angle}deg)`;
                slice.style.clipPath = `polygon(0 0, 100% 0, ${50 + 50 * Math.cos((360/denominator) * Math.PI / 180)}% ${50 + 50 * Math.sin((360/denominator) * Math.PI / 180)}%)`;
            });
            
            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
        }

        function toggleSlice(slice) {
            slice.classList.toggle('filled');
            const selectedCount = document.querySelectorAll('.pizza-slice.filled').length;
            const totalSlices = document.querySelectorAll('.pizza-slice').length;
            
            document.getElementById('selectedSlices').textContent = selectedCount;
            document.getElementById('currentFraction').textContent = `${selectedCount}/${totalSlices}`;
        }

        // Addition Game with visual support
        function loadAdditionGame() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * (20 - num1)) + 1;
            const sum = num1 + num2;
            gameState.currentQuestion = { correct: sum };

            const visual1 = 'üü¶'.repeat(num1);
            const visual2 = 'üü®'.repeat(num2);

            const options = [sum, sum + 1, sum - 1, sum + 2]
                .filter(n => n > 0)
                .sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Risolvi l'addizione visuale:</div>
                <div class="visual-area">
                    <div style="margin: 1rem 0;">
                        <div><strong>${num1} pallini:</strong></div>
                        <div>${visual1}</div>
                    </div>
                    <div style="font-size: 2rem; margin: 1rem;">‚ûï</div>
                    <div style="margin: 1rem 0;">
                        <div><strong>${num2} pallini:</strong></div>
                        <div>${visual2}</div>
                    </div>
                    <div style="font-size: 2rem; margin: 1rem;">üü∞</div>
                    <div><strong>Totale: ?</strong></div>
                </div>
                <div class="options">
                    ${options.map(num => `<div class="option" onclick="selectAnswer(${num})">${num}</div>`).join('')}
                </div>
            `;
        }

        // Multiplication Game (Tabelline)
        function loadMultiplicationGame() {
            const tables = gameState.currentClass >= 3 ? [2, 3, 4, 5, 6, 7, 8, 9, 10] : [2, 5, 10];
            const factor1 = tables[Math.floor(Math.random() * tables.length)];
            const factor2 = Math.floor(Math.random() * 10) + 1;
            const product = factor1 * factor2;
            gameState.currentQuestion = { correct: product };

            const options = [product, product + factor1, product - factor1, product + factor2]
                .filter(n => n > 0)
                .sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Quanto fa ${factor1} √ó ${factor2}?</div>
                <div class="visual-area">
                    <div style="font-size: 2rem; margin: 2rem 0;">${factor1} √ó ${factor2} = ?</div>
                    <div style="background: #EFF6FF; padding: 1rem; border-radius: 1rem;">
                        <strong>üí° Ricorda:</strong> La tabellina del ${factor1}!
                    </div>
                </div>
                <div class="options">
                    ${options.map(num => `<div class="option" onclick="selectAnswer(${num})">${num}</div>`).join('')}
                </div>
            `;
        }

        // Default game loader for other games
        function loadDefaultGame(gameId) {
            document.getElementById('gameContent').innerHTML = `
                <div class="question">Gioco: ${gameId}</div>
                <div class="visual-area">
                    <p>üöß Questo gioco √® in fase di sviluppo!</p>
                    <p>Torna presto per nuove avventure di apprendimento!</p>
                </div>
                <div style="margin: 2rem 0;">
                    <button class="nav-btn" onclick="goBackToClass()">üîô Torna ai Giochi</button>
                </div>
            `;
        }

        // Answer Selection Functions
        function selectAnswer(answer) {
            if (gameState.currentGame === 'frazioni-visual') {
                // For fractions game, answer is handled by checkAnswer
                return;
            }
            
            const isCorrect = answer == gameState.currentQuestion.correct;
            gameState.totalQuestions++;
            
            if (isCorrect) {
                gameState.correctAnswers++;
                gameState.streakCount++;
                addScore(10);
                showFeedback('‚úÖ Corretto! Ottimo lavoro!', 'success');
            } else {
                gameState.streakCount = 0;
                showFeedback(`‚ùå Non √® corretto. La risposta giusta era: ${gameState.currentQuestion.correct}`, 'error');
            }
            
            // Highlight correct/wrong answers
            const options = document.querySelectorAll('.option, .pattern-option, .sequence-option');
            options.forEach(option => {
                if (option.textContent == gameState.currentQuestion.correct) {
                    option.classList.add('correct');
                } else if (option.textContent == answer && !isCorrect) {
                    option.classList.add('wrong');
                }
                option.style.pointerEvents = 'none';
            });
            
            document.getElementById('nextQuestionBtn').style.display = 'inline-block';
            document.getElementById('newGameBtn').style.display = 'inline-block';
        }

        function selectPatternAnswer(answer) {
            selectAnswer(answer);
        }

        function checkAnswer() {
            if (gameState.currentGame === 'frazioni-visual') {
                const selectedSlices = document.querySelectorAll('.pizza-slice.filled').length;
                const targetNumerator = gameState.currentQuestion.numerator;
                
                gameState.totalQuestions++;
                
                if (selectedSlices === targetNumerator) {
                    gameState.correctAnswers++;
                    gameState.streakCount++;
                    addScore(15); // More points for interactive games
                    showFeedback('üéâ Perfetto! Hai selezionato la frazione corretta!', 'success');
                } else {
                    gameState.streakCount = 0;
                    showFeedback(`‚ùå Non √® corretto. Dovevi selezionare ${targetNumerator} fette, ne hai selezionate ${selectedSlices}.`, 'error');
                }
                
                document.getElementById('checkAnswerBtn').style.display = 'none';
                document.getElementById('nextQuestionBtn').style.display = 'inline-block';
                document.getElementById('newGameBtn').style.display = 'inline-block';
                
                // Disable further clicking
                document.querySelectorAll('.pizza-slice').forEach(slice => {
                    slice.style.pointerEvents = 'none';
                });
            }
        }

        function nextQuestion() {
            loadGame(gameState.currentGame);
        }

        // Scoring System
        function addScore(points) {
            gameState.score += points;
            
            // Bonus for streak
            if (gameState.streakCount >= 3) {
                gameState.score += 5;
                gameState.stars++;
            }
            
            // Level up system
            const newLevel = Math.floor(gameState.score / 100) + 1;
            if (newLevel > gameState.level) {
                gameState.level = newLevel;
                gameState.stars += 2;
                showMessage(`üéä Congratulazioni! Hai raggiunto il Livello ${newLevel}!`, 'success');
            }
            
            saveProgress();
            updateStatsDisplay();
        }

        function saveProgress() {
            localStorage.setItem('edutech-score', gameState.score.toString());
            localStorage.setItem('edutech-stars', gameState.stars.toString());
            localStorage.setItem('edutech-level', gameState.level.toString());
        }

        function updateStatsDisplay() {
            document.getElementById('stars-count').textContent = gameState.stars;
            document.getElementById('score-count').textContent = gameState.score;
            document.getElementById('level-count').textContent = gameState.level;
            
            // Show stats bar if there are points
            if (gameState.score > 0 || gameState.stars > 0) {
                document.getElementById('stats-bar').style.display = 'flex';
            }
        }

        function resetProgress() {
            if (confirm('Sei sicuro di voler azzerare tutti i progressi?')) {
                gameState.score = 0;
                gameState.stars = 0;
                gameState.level = 1;
                saveProgress();
                updateStatsDisplay();
                document.getElementById('stats-bar').style.display = 'none';
                showMessage('üîÑ Progressi azzerati! Ricomincia il tuo viaggio!', 'info');
            }
        }

        // Feedback System
        function showFeedback(message, type) {
            const feedback = document.createElement('div');
            feedback.className = `message ${type}`;
            feedback.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">${message}</div>
                <div style="font-size: 0.9rem; color: #666;">
                    Domande: ${gameState.totalQuestions} | Corrette: ${gameState.correctAnswers} | Serie: ${gameState.streakCount}
                </div>
            `;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 3000);
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge2NvbnNvbGUubG9nKCdTVyBpbnN0YWxsZWQnKTt9KTtzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgZXZlbnQgPT4ge2NvbnNvbGUubG9nKCdTVyBhY3RpdmF0ZWQnKTt9KTs=')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Handle orientation changes for better responsive experience
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                deviceDetector.deviceInfo = deviceDetector.detectDevice();
                deviceDetector.displayDeviceInfo();
                deviceDetector.applyDeviceStyles();
            }, 100);
        });

        // Handle window resize for dynamic device detection
        window.addEventListener('resize', function() {
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                deviceDetector.deviceInfo = deviceDetector.detectDevice();
                deviceDetector.displayDeviceInfo();
                deviceDetector.applyDeviceStyles();
            }, 150);
        });
    </script>
</body>
</html>
